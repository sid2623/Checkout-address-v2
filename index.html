<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout ‚Äî DIGIPIN + Maps</title>

  <!-- Tailwind CDN for quick styling (optional) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f7fafc;
      --card: #ffffff;
      --muted: #6b7280;
      --primary: linear-gradient(90deg,#a8e063,#56ab2f);
      --radius: 14px;
    }
    html,body { height:100%; background:var(--bg); font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; }
    main { max-width:420px; margin:18px auto; background:var(--card); border-radius:18px; overflow:hidden; box-shadow:0 6px 20px rgba(16,24,40,0.08); min-height:88vh; display:flex; flex-direction:column; }
    header { padding:14px 16px; border-bottom:1px solid #eef2f7; display:flex; align-items:center; gap:10px; }
    header h1 { margin:0; font-size:15px; font-weight:500; color:#111827; letter-spacing:0.1px; }
    /* Map area */
    .map-wrap { position:relative; flex:1 1 auto; min-height:56vh; }
    #map { position:absolute; inset:0; border-bottom:1px solid #eef2f7; }
    .search-box { position:absolute; top:12px; left:12px; right:12px; display:flex; gap:8px; z-index:20; }
    .search-input { flex:1; background:var(--card); border-radius:12px; box-shadow:0 6px 18px rgba(2,6,23,0.06); padding:10px 12px; border:1px solid #e6eef6; font-size:14px; color:#111827; }
    .search-clear { width:40px; display:flex; align-items:center; justify-content:center; background:var(--card); border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.06); border:1px solid #e6eef6; font-size:16px; color:var(--muted); }
    /* Center marker indicator (visual) */
    .center-indicator { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:10; pointer-events:none; text-align:center; }
    .center-indicator .pin { font-size:20px; color:#ef4444; transform:translateY(-6px); }
    .center-indicator .hint { background:#0f172a; color:#fff; font-size:11px; padding:6px 10px; border-radius:10px; margin-bottom:6px; display:inline-block; opacity:0.95; }
    /* Current location button bottom-right, non-overlapping */
    .loc-btn { position:absolute; bottom:18px; right:12px; z-index:20; display:flex; align-items:center; gap:8px; background:var(--card); padding:8px 12px; border-radius:999px; box-shadow:0 8px 24px rgba(2,6,23,0.08); border:1px solid #eef2f7; font-size:13px; cursor:pointer; }
    /* Address card */
    .address-card { padding:14px; background:var(--card); border-top-left-radius:18px; border-top-right-radius:18px; border-top:1px solid #eef2f7; }
    .address-row { display:flex; justify-content:space-between; gap:8px; align-items:center; font-size:13px; color: #111827; }
    .muted { color:var(--muted); font-size:13px; }
    .mono { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-weight:500; font-size:13px; color:#0f172a; }
    .btn { width:100%; padding:12px 14px; border-radius:12px; border:none; font-weight:600; font-size:15px; cursor:pointer; background:var(--primary); color:white; box-shadow:0 8px 24px rgba(16,185,129,0.12); }
    /* Responsive small tweaks */
    @media (max-width:420px){
      .search-input { font-size:13px; padding:9px 10px; }
      .loc-btn { font-size:12px; padding:8px 10px; }
    }
  </style>
</head>
<body>

<main>
  <header>
    <h1>Add delivery address</h1>
  </header>

  <div class="map-wrap">
    <!-- Search -->
    <div class="search-box">
      <input id="search-input" class="search-input" placeholder="Search for area, locality or building" type="text" />
      <button id="clear-search" class="search-clear" aria-label="clear search">&times;</button>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Center indicator -->
    <div class="center-indicator" aria-hidden="true">
      <div class="hint">Order will be delivered here</div>
      <div class="pin">üìç</div>
    </div>

    <!-- Use current location button (bottom-right, non-overlapping) -->
    <button id="current-location-btn" class="loc-btn" title="Use current device location">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg>
      Use current location
    </button>
  </div>

  <!-- Address details -->
  <div class="address-card">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
      <div>
        <div class="muted">DIGIPIN</div>
        <div id="digipin-display" class="mono">Fetching...</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Co-ords</div>
        <div id="coords-display" class="mono">Fetching...</div>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="muted">Address</div>
      <div id="address-display" style="margin-top:4px; font-size:14px; color:#111827; line-height:1.35;">Fetching address...</div>
    </div>

    <div style="margin-top:12px;">
      <button id="next-btn-1" class="btn">Next (Add Door No.)</button>
    </div>
  </div>
  <!-- STEP 2: Confirm contact & door (hidden by default) -->
<div id="step2-panel" style="display:none; padding:14px; background:var(--card); border-top:1px solid #eef2f7;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <div>
      <div style="font-size:13px; color:var(--muted);">Confirm delivery details</div>
      <div style="font-weight:600; font-size:14px; color:#111827;">Add door no, name & mobile</div>
    </div>
    <button id="back-to-map" style="background:none;border:none;color:#6b7280; font-weight:600; cursor:pointer;">Back</button>
  </div>

  <div style="display:grid; gap:10px;">
    <label style="font-size:13px; color:var(--muted);">Co-ordinates</label>
    <div id="confirm-coords" class="mono" style="margin-bottom:6px;">-</div>

    <div>
      <label class="muted" style="display:block;margin-bottom:6px;">Door No (optional)</label>
      <input id="door-no-input" type="text" placeholder="Eg: 12B, Flat 3" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e6eef6; font-size:14px;">
    </div>

    <div>
      <label class="muted" style="display:block;margin-bottom:6px;">Name</label>
      <input id="name-input" type="text" placeholder="Full name" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e6eef6; font-size:14px;">
    </div>

    <div>
      <label class="muted" style="display:block;margin-bottom:6px;">Mobile</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="mobile-input" type="tel" placeholder="10 digit mobile" style="flex:1; padding:10px; border-radius:8px; border:1px solid #e6eef6; font-size:14px;">
        <div id="mobile-valid-icon" style="width:28px; height:28px; display:none; align-items:center; justify-content:center; border-radius:8px; background:#ecfdf5; color:#10b981; font-weight:600;">‚úì</div>
      </div>
    </div>

    <div>
      <label class="muted" style="display:block;margin-bottom:6px;">Full address</label>
      <div id="full-address-display" style="font-size:14px; color:#111827; line-height:1.3; white-space:pre-wrap; padding:10px; border-radius:8px; border:1px solid #eef2f7; background:#fafafa;">-</div>
    </div>

    <button id="confirm-btn" class="btn" style="margin-top:6px;">Confirm & Continue</button>
  </div>
</div>
<!-- STEP 3: Payment -->
<div id="step3" style="display:none; padding:14px; background:var(--card); border-top:1px solid #eef2f7;">
  <h3 style="text-align:center;font-weight:600;font-size:16px;margin-bottom:10px;">Payment Options</h3>
  <div style="border:1px solid #e6eef6;padding:10px;border-radius:12px;margin-bottom:10px;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-weight:700;">Debit on Delivery</div>
        <div style="font-size:12px;color:#6b7280;">UPI mandate, charged only after delivery</div>
      </div>
      <div style="text-align:right;">
        <div style="color:#10b981;font-weight:700;">Rs. 899.00</div>
        <div style="font-size:12px;color:#6b7280;">Save ‚Çπ100</div>
      </div>
    </div>
  </div>

  <div class="option" data-id="upi" style="border:1px solid #e6eef6;padding:10px;border-radius:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
    <span style="font-weight:600;">UPI</span><span>Rs. 999.00</span>
  </div>
  <div class="option" data-id="card" style="border:1px solid #e6eef6;padding:10px;border-radius:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
    <span style="font-weight:600;">Cards</span><span>Rs. 999.00</span>
  </div>
  <div class="option" data-id="netbank" style="border:1px solid #e6eef6;padding:10px;border-radius:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
    <span style="font-weight:600;">Netbanking</span><span>Rs. 999.00</span>
  </div>
  <div class="option" data-id="cod" style="border:1px solid #e6eef6;padding:10px;border-radius:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
    <span style="font-weight:600;">COD <span style="font-weight:400;color:#6b7280;">+ ‚Çπ199 surcharge</span></span><span style="color:#ef4444;">Rs. 1199.00</span>
  </div>

  <button id="pay-now-btn" class="btn" style="margin-top:12px;">Pay Now ‚Üí</button>
</div>

<!-- STEP 4: Success -->
<div id="step4" style="display:none;text-align:center;padding:20px;">
  <div style="font-size:40px;color:#10b981;">‚úì</div>
  <h2 style="font-weight:700;margin:6px 0;">Payment Successful!</h2>
  <p style="font-size:14px;color:#6b7280;">Your order has been placed.</p>
  <button id="start-again-btn" class="btn" style="margin-top:12px;">Place Another Order</button>
</div>

</main>

<!-- Google Maps JS (keep callback initMap) -->
<script>
  /*****************
   *  STATE
   *****************/
  const state = {
    coords: null,
    digipin: null,
    geocodedAddress: null
  };

  /*****************
   *  DIGIPIN generation (your function, slightly cleaned)
   *****************/
  function getDigipin(lat, lon){
    const L = [
      ['F','C','9','8'], ['J','3','2','7'],
      ['K','4','5','6'], ['L','M','P','T']
    ];
    let vDIGIPIN = '';
    let row = 0, column = 0;
    let minLat = 2.5, maxLat = 38.5;
    let minLon = 63.5, maxLon = 99.5;
    const latDivBy = 4, lonDivBy = 4;

    if (lat < minLat || lat > maxLat || lon < minLon || lon > maxLon) {
      return 'Out of Range';
    }

    for (let lvl = 1; lvl <= 10; lvl++){
      const latDivDeg = (maxLat - minLat) / latDivBy;
      const lonDivDeg = (maxLon - minLon) / lonDivBy;

      for (let i=0;i<latDivBy;i++){
        if (lat >= maxLat - (i+1)*latDivDeg && lat < maxLat - i*latDivDeg) { row = i; break; }
      }
      for (let i=0;i<lonDivBy;i++){
        if (lon >= minLon + i*lonDivDeg && lon < minLon + (i+1)*lonDivDeg) { column = i; break; }
      }

      vDIGIPIN += L[row][column];

      if (lvl === 3 || lvl === 6) vDIGIPIN += '-';

      maxLat = maxLat - row * latDivDeg;
      minLat = maxLat - latDivDeg;
      minLon = minLon + column * lonDivDeg;
      maxLon = minLon + lonDivDeg;
    }
    return vDIGIPIN;
  }

  /*****************
   *  Map, Places, Geocoder (client)
   *****************/
  let map, geocoder, autocomplete;
  const defaultPosition = { lat: 17.3850, lng: 78.4867 }; // Hyderabad

  function initMap(){
    map = new google.maps.Map(document.getElementById('map'), {
      center: defaultPosition,
      zoom: 15,
      disableDefaultUI: true,
      gestureHandling: 'greedy'
    });

    geocoder = new google.maps.Geocoder();

    setupSearchAutocomplete();
    // Update details initially
    updateLocationDetails(map.getCenter());

    // When map center changes (pan/zoom), update after a tiny throttle
    let t;
    map.addListener('center_changed', () => {
      clearTimeout(t);
      t = setTimeout(() => { updateLocationDetails(map.getCenter()); }, 200);
    });
  }

  // --- Places Autocomplete using the Maps JS library (client-side) ---
  function setupSearchAutocomplete(){
    const input = document.getElementById('search-input');
    autocomplete = new google.maps.places.Autocomplete(input, { fields: ['geometry','formatted_address','name'] });
    autocomplete.bindTo('bounds', map);

    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (place.geometry && place.geometry.location){
        map.panTo(place.geometry.location);
        map.setZoom(17);
        // updateLocationDetails will run from center_changed listener
      }
    });

    document.getElementById('clear-search').addEventListener('click', () => {
      input.value = '';
    });
  }

  // --- Update UI after obtaining coordinates ---
  function updateLocationDetails(latLng){
    // latLng may be a LatLng object or a plain object
    const lat = (typeof latLng.lat === 'function') ? latLng.lat() : latLng.lat;
    const lng = (typeof latLng.lng === 'function') ? latLng.lng() : latLng.lng;

    state.coords = { lat, lng };
    document.getElementById('coords-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    document.getElementById('digipin-display').textContent = 'Generating...';
    document.getElementById('address-display').textContent = 'Fetching address...';

    // DIGIPIN
    state.digipin = getDigipin(lat, lng);
    document.getElementById('digipin-display').textContent = state.digipin;

    // Client-side reverse geocode (fast, uses the Maps JS geocoder)
    reverseGeocodeClient(lat, lng).then(address => {
      state.geocodedAddress = address || 'No address found';
      document.getElementById('address-display').textContent = state.geocodedAddress;
    }).catch(err => {
      state.geocodedAddress = 'Address unavailable';
      document.getElementById('address-display').textContent = state.geocodedAddress;
      console.error('Reverse geocode error (client):', err);
    });
  }

  // Client-side geocoder using the Maps JS geocoder (no REST call)
  function reverseGeocodeClient(lat, lng){
    return new Promise((resolve, reject) => {
      if (!geocoder) return reject('Geocoder not initialized');
      geocoder.geocode({ location: { lat, lng } }, (results, status) => {
        if (status === 'OK' && results[0]) {
          resolve(results[0].formatted_address);
        } else if (status === 'OK') {
          resolve(null);
        } else {
          reject(status);
        }
      });
    });
  }

  /*****************
   *  Current location button
   *  (keeps UI non-overlapping)
   *****************/
  document.getElementById('current-location-btn').addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert("Location not supported by your browser.");
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.panTo(p);
      map.setZoom(17);
    }, err => {
      console.error(err);
      alert('Unable to retrieve your location.');
    }, { enableHighAccuracy: true, timeout: 8000 });
  });

  /*****************
   *  Navigation: Next button (example behavior)
   *****************/
 // Step 2 elements
const step2Panel = document.getElementById('step2-panel');
const confirmCoords = document.getElementById('confirm-coords');
const doorNoInput = document.getElementById('door-no-input');
const nameInput = document.getElementById('name-input');
const mobileInput = document.getElementById('mobile-input');
const mobileValidIcon = document.getElementById('mobile-valid-icon');
const fullAddressDisplay = document.getElementById('full-address-display');
const confirmBtn = document.getElementById('confirm-btn');
const backToMap = document.getElementById('back-to-map');
const nextBtn1 = document.getElementById('next-btn-1');

// Show Step 2 when Next is clicked
nextBtn1.addEventListener('click', () => {
  // Ensure coords and address are present
  if (!state.coords) {
    alert('Location not ready yet ‚Äî please wait a moment and try again.');
    return;
  }

  // Populate step2 fields
  confirmCoords.textContent = `${state.coords.lat.toFixed(6)}, ${state.coords.lng.toFixed(6)}`;
  doorNoInput.value = state.doorNo || '';
  nameInput.value = state.name || '';
  mobileInput.value = state.mobile || '';
  updateFullAddressDisplay();

  // Toggle UI: hide map area and show step2
  // We'll hide the main map container visually: (the map remains but panel overlays)
  // If you prefer a full page switch, you can hide the map-wrap; this overlay is simpler.
  step2Panel.style.display = 'block';
  // Optional: scroll map out of view to focus on form
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
});

// Back to map
backToMap.addEventListener('click', () => {
  step2Panel.style.display = 'none';
  // focus map search so user can continue
  document.getElementById('search-input').focus();
});

// Mobile validation and UI
mobileInput.addEventListener('input', (e) => {
  const v = e.target.value.replace(/\D/g,''); // digits only
  e.target.value = v;
  state.mobile = v;
  if (/^\d{10}$/.test(v)) {
    mobileValidIcon.style.display = 'flex';
  } else {
    mobileValidIcon.style.display = 'none';
  }
  updateFullAddressDisplay();
});

// Door and name updates
doorNoInput.addEventListener('input', (e) => { state.doorNo = e.target.value; updateFullAddressDisplay(); });
nameInput.addEventListener('input', (e) => { state.name = e.target.value; updateFullAddressDisplay(); });

// Confirm button (proceed to payment or next step)
confirmBtn.addEventListener('click', () => {
  if (!state.name || state.name.trim().length < 2) {
    alert('Please enter a valid name.');
    nameInput.focus();
    return;
  }
  if (!/^\d{10}$/.test(state.mobile)) {
    alert('Please enter a valid 10-digit mobile number.');
    mobileInput.focus();
    return;
  }

  step2Panel.style.display = 'none';
  document.getElementById('step3').style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
});


// Utility: compose full address shown in step 2
function updateFullAddressDisplay(){
  let parts = [];
  if (state.name) parts.push(state.name);
  if (state.mobile) parts.push(state.mobile);
  let addr = '';
  if (state.doorNo) addr += state.doorNo + ', ';
  addr += (state.geocodedAddress || '');
  const full = (parts.length ? parts.join('\n') + '\n' : '') + addr;
  fullAddressDisplay.innerText = full || '-';
}

  /*****************
   *  Expose initMap to global (callback used in Google script)
   *****************/
  window.initMap = initMap;
  
  // Payment logic
const payNowBtn = document.getElementById('pay-now-btn');
const step3 = document.getElementById('step3');
const step4 = document.getElementById('step4');
const startAgainBtn = document.getElementById('start-again-btn');

payNowBtn.addEventListener('click', () => {
  step3.style.display = 'none';
  step4.style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

startAgainBtn.addEventListener('click', () => {
  step4.style.display = 'none';
  document.getElementById('step2-panel').style.display = 'none';
  step1.scrollIntoView({ behavior: 'smooth' });
});

</script>

<!-- Load Google Maps JS: replace YOUR_GOOGLE_MAPS_API_KEY with your key.
     Keep &libraries=places so Places Autocomplete works. -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=&libraries=places&callback=initMap">
</script>

</body>
</html>
