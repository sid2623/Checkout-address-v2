<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mobile Checkout — DIGIPIN + Maps (Buttons Visible)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body,#app { height:100%; }
    body { background:#f3f4f6; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .phone-frame { max-width:420px; margin:18px auto; border-radius:26px; background:white; box-shadow: 0 18px 30px rgba(0,0,0,0.08); overflow:hidden; border:6px solid rgba(43,19,32,0.08); }
    header { padding:16px 14px; text-align:center; font-weight:700; font-size:20px; }
    .content { padding:12px 14px 88px 14px; min-height:560px; } /* bottom padding to allow sticky footer */
    .card { background:white; border-radius:12px; padding:10px; border:1px solid #e6e7ea; box-shadow:0 2px 0 rgba(0,0,0,0.02); }
    .search-input { width:100%; height:44px; border-radius:10px; border:1px solid #d6d6d6; padding:8px 12px; background:#fff; }
    #map { width:100%; height:240px; border-radius:12px; overflow:hidden; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:12px 16px; border-radius:12px; font-weight:700; font-size:15px; }
    .primary { background: linear-gradient(90deg,#34c759,#8ee12c); color:white; box-shadow: 0 6px 18px rgba(50,160,80,0.12); }
    .muted { background:#fff; color:#222; border:1px solid #e2e2e2; }
    .field { display:block; width:100%; padding:12px; border-radius:12px; border:1px solid #d0d0d0; background:white; }
    .small { font-size:13px; color:#666; }
    .pill { display:inline-block; padding:8px 12px; border-radius:12px; background:#f7f7f8; border:1px solid #ececec; }
    .payment-option { display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:12px; border:1px solid #e6e6e6; background:white; margin-bottom:10px; }
    .footer-sticky { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; width:calc(100% - 64px); max-width:392px; z-index:50; }
    .footer-inner { display:flex; gap:10px; }
    .hidden { display:none !important; }
    .error { color:#c62828; font-size:13px; margin-top:6px; }
    /* ensure long content scroll */
    .step { max-height:calc(100vh - 170px); overflow:auto; padding-bottom:8px; }
  </style>
</head>
<body>
  <div id="app" class="phone-frame">
    <header>Add delivery address</header>

    <div class="content">
      <!-- STEP 1 -->
      <div id="step-1" class="step card">
        <label class="small mb-2 block">Search address</label>
        <input id="pac-input" class="search-input mb-3" placeholder="Search place or address" type="text" />

        <div id="map" class="mb-3"></div>

        <div class="flex items-center gap-2 mb-3">
          <button id="use-location" class="btn muted w-full">Use Current Location</button>
        </div>

        <div class="card p-3">
          <div class="small text-gray-600">DIGIPIN: <span id="digipin" class="font-semibold">—</span></div>
          <div class="small text-gray-600 mt-2">Co-ords: <span id="coords" class="font-medium">—</span></div>
          <div class="mt-3 text-sm font-semibold" id="address-text">Address not available</div>
        </div>
      </div>

      <!-- STEP 2 -->
      <div id="step-2" class="step hidden card">
        <div class="mb-3">
          <label class="small">Co-ordinates</label>
          <div class="pill mt-1" id="coords-pill">—</div>
        </div>

        <div class="mb-3">
          <label class="small">Door No. (optional)</label>
          <input id="door" class="field mt-1" placeholder="Flat / Door / Building name (optional)" />
        </div>

        <div class="mb-3">
          <label class="small">Name</label>
          <input id="name" class="field mt-1" placeholder="Full name" />
        </div>

        <div class="mb-3">
          <label class="small">Mobile</label>
          <input id="mobile" class="field mt-1" placeholder="10 digit mobile" inputmode="numeric" />
          <div id="mobile-error" class="error hidden">Enter a valid 10 digit mobile number.</div>
        </div>
      </div>

      <!-- STEP 3 -->
      <div id="step-3" class="step hidden">
        <div class="mb-3">
          <h3 class="text-lg font-bold">Order Details</h3>
          <div class="card mt-2 p-3">
            <div class="flex items-center gap-3">
              <div style="width:54px;height:54px;border-radius:8px;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-weight:700;">IMG</div>
              <div>
                <div class="font-semibold">Slides</div>
                <div class="small text-gray-500">Size: 9UK, Black</div>
              </div>
              <div class="ml-auto font-semibold text-red-600">Rs. 999.00</div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <h3 class="text-lg font-bold">Delivery</h3>
          <div class="card mt-2 p-3">
            <div class="small text-gray-600">Name</div>
            <div class="font-medium" id="review-name">—</div>
            <div class="small text-gray-600 mt-2">Mobile</div>
            <div class="font-medium" id="review-mobile">—</div>
            <div class="small text-gray-600 mt-2">Address</div>
            <div class="font-medium" id="review-address">—</div>
            <div class="small text-gray-600 mt-2">Co-ords & DIGIPIN</div>
            <div class="font-medium" id="review-coords-digipin">—</div>
          </div>
        </div>

        <div class="mb-3">
          <h3 class="text-lg font-bold mb-2">Payment Options</h3>
          <div id="payments">
            <label class="payment-option">
              <div>
                <div class="font-semibold">Debit on Delivery</div>
                <div class="small">One-time UPI mandate; debited after delivery</div>
              </div>
              <div>Rs. 899</div>
              <input name="payment" type="radio" value="dod" />
            </label>

            <label class="payment-option">
              <div><div class="font-semibold">UPI</div></div>
              <div>Rs. 999</div>
              <input name="payment" type="radio" value="upi" />
            </label>

            <label class="payment-option">
              <div><div class="font-semibold">Cards</div></div>
              <div>Rs. 999</div>
              <input name="payment" type="radio" value="card" />
            </label>

            <label class="payment-option">
              <div>
                <div class="font-semibold">Cash on Delivery (COD)</div>
                <div class="small">+ Rs.199 surcharge</div>
              </div>
              <div class="text-red-600">Rs. 1198</div>
              <input name="payment" type="radio" value="cod" />
            </label>
          </div>
        </div>
      </div>

      <!-- SUCCESS -->
      <div id="success" class="hidden text-center card">
        <div style="padding:22px;">
          <div style="width:68px;height:68px;border-radius:999px;background:#eaf9ee;margin:12px auto;display:flex;align-items:center;justify-content:center;font-size:28px;color:#2a7f35;">✓</div>
          <h2 class="font-bold text-xl">Order Confirmed</h2>
          <p class="mt-2 text-sm text-gray-600">Your order has been placed successfully.</p>
        </div>
      </div>

    </div> <!-- content -->

    <!-- Sticky footer with action buttons (always visible) -->
    <div class="footer-sticky">
      <div id="footer-1" class="footer-inner">
        <button id="to-step-2" class="btn primary w-full">Next (Add Door No.)</button>
      </div>

      <div id="footer-2" class="footer-inner hidden">
        <button id="back-to-1" class="btn muted w-1/2">Back</button>
        <button id="to-step-3" class="btn primary w-1/2">Continue</button>
      </div>

      <div id="footer-3" class="footer-inner hidden">
        <button id="back-to-2" class="btn muted w-1/2">Back</button>
        <button id="pay-now" class="btn primary w-1/2">Pay Now</button>
      </div>

      <div id="footer-success" class="footer-inner hidden">
        <button id="start-over" class="btn primary w-full">Place New Order</button>
      </div>
    </div>

  </div> <!-- frame -->

  <script>
    let map, marker, geocoder, autocomplete;
    const state = { lat: null, lon: null, address: '', digipin: '', door:'', name:'', mobile:'' };

    function Get_DIGIPIN(lat, lon) {
      const L = [['F','C','9','8'],['J','3','2','7'],['K','4','5','6'],['L','M','P','T']];
      let vDIGIPIN = '';
      let MinLat = 2.5, MaxLat = 38.50, MinLon = 63.50, MaxLon = 99.50;
      let LatDivBy = 4, LonDivBy = 4;
      if (lat < MinLat || lat > MaxLat || lon < MinLon || lon > MaxLon) {
        const fixedLat = Math.abs(lat).toString().replace('.','').slice(0,5);
        const fixedLon = Math.abs(lon).toString().replace('.','').slice(0,5);
        return `${fixedLat}-${fixedLon}`;
      }
      for (let Lvl=1; Lvl<=10; Lvl++) {
        const LatDivDeg = (MaxLat - MinLat) / LatDivBy;
        const LonDivDeg = (MaxLon - MinLon) / LonDivBy;
        let NextLvlMaxLat = MaxLat;
        let NextLvlMinLat = MaxLat - LatDivDeg;
        let row = 0;
        for (let x=0; x<LatDivBy; x++){
          if (lat >= NextLvlMinLat && lat < NextLvlMaxLat) { row = x; break; }
          NextLvlMaxLat = NextLvlMinLat;
          NextLvlMinLat = NextLvlMaxLat - LatDivDeg;
        }
        let NextLvlMinLon = MinLon;
        let NextLvlMaxLon = MinLon + LonDivDeg;
        let column = 0;
        for (let x=0; x<LonDivBy; x++){
          if (lon >= NextLvlMinLon && lon < NextLvlMaxLon) { column = x; break; }
          else if ((NextLvlMinLon + LonDivDeg) < MaxLon) {
            NextLvlMinLon = NextLvlMaxLon;
            NextLvlMaxLon = NextLvlMinLon + LonDivDeg;
          } else { column = x; }
        }
        vDIGIPIN += L[row][column];
        if (Lvl === 3 || Lvl === 6) vDIGIPIN += '-';
        MinLat = NextLvlMinLat; MaxLat = NextLvlMaxLat;
        MinLon = NextLvlMinLon; MaxLon = NextLvlMaxLon;
      }
      return vDIGIPIN;
    }

    function updateUI() {
      document.getElementById('digipin').innerText = state.digipin || '—';
      document.getElementById('coords').innerText = (state.lat && state.lon) ? `${state.lat.toFixed(7)}, ${state.lon.toFixed(7)}` : '—';
      document.getElementById('coords-pill').innerText = (state.lat && state.lon) ? `${state.lat.toFixed(7)}, ${state.lon.toFixed(7)}` : '—';
      document.getElementById('address-text').innerText = state.address || 'Address not available';
    }

    function reverseGeocode(lat, lon) {
      if (!geocoder) return;
      geocoder.geocode({ location: { lat: parseFloat(lat), lng: parseFloat(lon) } }, function(results, status) {
        if (status === 'OK' && results[0]) {
          state.address = results[0].formatted_address;
        } else {
          state.address = `Lat ${lat.toFixed(6)}, Lon ${lon.toFixed(6)}`;
        }
        state.digipin = Get_DIGIPIN(lat, lon);
        updateUI();
      });
    }

    function initMap() {
      const defaultCenter = { lat: 17.50383899, lng: 78.40651236 };
      map = new google.maps.Map(document.getElementById('map'), { center: defaultCenter, zoom:15, disableDefaultUI:true, gestureHandling:'greedy' });
      geocoder = new google.maps.Geocoder();
      marker = new google.maps.Marker({ position: defaultCenter, map, draggable:true, title:'Drop pin where delivery should happen' });

      map.addListener('click', (e) => placeMarker(e.latLng));
      marker.addListener('dragend', (e) => {
        const lat = e.latLng.lat(), lon = e.latLng.lng();
        state.lat = lat; state.lon = lon; reverseGeocode(lat, lon);
      });

      const input = document.getElementById('pac-input');
      autocomplete = new google.maps.places.Autocomplete(input, { fields: ["geometry","formatted_address","name"] });
      autocomplete.bindTo('bounds', map);
      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) { alert("No details available for the selected place."); return; }
        const loc = place.geometry.location;
        map.panTo(loc); map.setZoom(17); placeMarker(loc);
      });

      state.lat = defaultCenter.lat; state.lon = defaultCenter.lng;
      reverseGeocode(defaultCenter.lat, defaultCenter.lng);
    }

    function placeMarker(latLng) {
      const lat = latLng.lat ? latLng.lat() : latLng.lat;
      const lon = latLng.lng ? latLng.lng() : latLng.lng;
      marker.setPosition(latLng);
      map.panTo(latLng);
      state.lat = lat; state.lon = lon;
      reverseGeocode(lat, lon);
    }

    document.getElementById('use-location').addEventListener('click', () => {
      if (!navigator.geolocation) { alert('Geolocation not supported.'); return; }
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        placeMarker({ lat, lng: lon });
        map.setZoom(17);
      }, (err) => alert('Could not get location: ' + err.message), { enableHighAccuracy:true, timeout:7000 });
    });

    function showStep(n) {
      document.getElementById('step-1').classList.add('hidden');
      document.getElementById('step-2').classList.add('hidden');
      document.getElementById('step-3').classList.add('hidden');
      document.getElementById('success').classList.add('hidden');
      document.getElementById('footer-1').classList.add('hidden');
      document.getElementById('footer-2').classList.add('hidden');
      document.getElementById('footer-3').classList.add('hidden');
      document.getElementById('footer-success').classList.add('hidden');
      if (n === 1) { document.getElementById('step-1').classList.remove('hidden'); document.getElementById('footer-1').classList.remove('hidden'); }
      if (n === 2) { document.getElementById('step-2').classList.remove('hidden'); document.getElementById('footer-2').classList.remove('hidden'); }
      if (n === 3) { document.getElementById('step-3').classList.remove('hidden'); document.getElementById('footer-3').classList.remove('hidden'); }
      if (n === 'success') { document.getElementById('success').classList.remove('hidden'); document.getElementById('footer-success').classList.remove('hidden'); }
      // small scroll to top when switching
      document.querySelector('.content').scrollTop = 0;
      updateUI();
    }

    // button events
    document.getElementById('to-step-2').addEventListener('click', () => {
      if (!state.lat || !state.lon) { alert('Please select location on the map first.'); return; }
      document.getElementById('door').value = state.door || '';
      document.getElementById('name').value = state.name || '';
      document.getElementById('mobile').value = state.mobile || '';
      showStep(2);
    });
    document.getElementById('back-to-1').addEventListener('click', () => showStep(1));
    document.getElementById('to-step-3').addEventListener('click', () => {
      const name = document.getElementById('name').value.trim();
      const mobile = document.getElementById('mobile').value.trim();
      const door = document.getElementById('door').value.trim();
      const mvalid = /^\d{10}$/.test(mobile);
      if (!mvalid) { document.getElementById('mobile-error').classList.remove('hidden'); return; }
      document.getElementById('mobile-error').classList.add('hidden');
      state.name = name; state.mobile = mobile; state.door = door;
      const fullAddress = buildFullAddress();
      document.getElementById('review-name').innerText = state.name || '-';
      document.getElementById('review-mobile').innerText = state.mobile || '-';
      document.getElementById('review-address').innerText = fullAddress;
      document.getElementById('review-coords-digipin').innerText = `${state.lat.toFixed(7)}, ${state.lon.toFixed(7)} — ${state.digipin}`;
      showStep(3);
    });
    document.getElementById('back-to-2').addEventListener('click', () => showStep(2));
    document.getElementById('pay-now').addEventListener('click', () => {
      const chosen = document.querySelector('input[name="payment"]:checked');
      if (!chosen) { alert('Please choose a payment option.'); return; }
      showStep('success');
    });
    document.getElementById('start-over').addEventListener('click', () => {
      state.lat = null; state.lon = null; state.address=''; state.digipin=''; state.door=''; state.name=''; state.mobile='';
      document.getElementById('pac-input').value = '';
      updateUI();
      showStep(1);
      if (map) map.setCenter({ lat:17.50383899, lng:78.40651236 });
    });

    function buildFullAddress() {
      let parts = [];
      if (state.name) parts.push(state.name + ',');
      if (state.mobile) parts.push(state.mobile + ',');
      if (state.door) parts.push(state.door + ',');
      if (state.address) parts.push(state.address);
      return parts.join(' ').replace(/\s+,/g, ',');
    }

    function loadGoogleMaps() {
      const script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=&libraries=places&callback=initMap';
      script.defer = true; script.async = true;
      window.initMap = initMap;
      document.head.appendChild(script);
    }

    updateUI();
    loadGoogleMaps();
    showStep(1);
  </script>
</body>
</html>
