<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mobile Checkout — DIGIPIN + Maps</title>

  <!-- Tailwind for quick mobile-first styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small local tweaks */
    html,body,#app { height:100%; }
    body { background:#f3f4f6; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .phone-frame { max-width:420px; margin:18px auto; border-radius:26px; background:white; box-shadow: 0 18px 30px rgba(0,0,0,0.08); overflow:hidden; border:6px solid #2b132033; }
    header { padding:18px 16px; text-align:center; font-weight:700; font-size:20px; }
    .content { padding:12px 16px 28px 16px; min-height:560px; }
    .card { background:white; border-radius:14px; padding:10px; border:1px solid #e6e7ea; box-shadow:0 2px 0 rgba(0,0,0,0.02); }
    .search-input { width:100%; height:44px; border-radius:10px; border:1px solid #d6d6d6; padding:8px 12px; background:#fff; }
    #map { width:100%; height:320px; border-radius:12px; overflow:hidden; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:12px 16px; border-radius:12px; font-weight:600; }
    .primary { background: linear-gradient(90deg,#8ee12c,#56c25e); color:white; }
    .muted { background:#f3f4f6; color:#222; border:1px solid #e2e2e2; }
    .field { display:block; width:100%; padding:12px; border-radius:12px; border:1px solid #d0d0d0; background:white; }
    .small { font-size:13px; color:#666; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #e6e6e6; }
    .payment-option { display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:12px; border:1px solid #e6e6e6; background:white; margin-bottom:10px; }
    .error { color:#c62828; font-size:13px; margin-top:6px; }
  </style>
</head>
<body>
  <div id="app" class="phone-frame">
    <header>Add delivery address</header>

    <div class="content">
      <!-- STEP containers -->
      <div id="step-1" class="step card">
        <label class="small mb-2 block">Search address</label>
        <input id="pac-input" class="search-input mb-3" placeholder="Search place or address" type="text" />

        <div id="map" class="mb-3"></div>

        <div class="flex items-center gap-2 mb-3">
          <button id="use-location" class="btn muted w-full">Use Current Location</button>
        </div>

        <div class="card p-3">
          <div class="small text-gray-600">DIGIPIN: <span id="digipin" class="font-semibold">—</span></div>
          <div class="small text-gray-600 mt-2">Co-ords: <span id="coords" class="font-medium">—</span></div>
          <div class="mt-3 text-sm font-semibold" id="address-text">Address not available</div>
        </div>

        <div class="mt-4">
          <button id="to-step-2" class="btn primary w-full">Next (Add Door No. & Contact)</button>
        </div>
      </div>

      <div id="step-2" class="step hidden">
        <div class="mb-3">
          <label class="small">Co-ordinates</label>
          <div class="pill mt-1" id="coords-pill">—</div>
        </div>

        <div class="mb-3">
          <label class="small">Door No. (optional)</label>
          <input id="door" class="field mt-1" placeholder="Flat / Door / Building name (optional)" />
        </div>

        <div class="mb-3">
          <label class="small">Name</label>
          <input id="name" class="field mt-1" placeholder="Full name" />
        </div>

        <div class="mb-3">
          <label class="small">Mobile</label>
          <input id="mobile" class="field mt-1" placeholder="10 digit mobile" inputmode="numeric" />
          <div id="mobile-error" class="error hidden">Enter a valid 10 digit mobile number.</div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="back-to-1" class="btn muted w-1/2">Back</button>
          <button id="to-step-3" class="btn primary w-1/2">Continue</button>
        </div>
      </div>

      <div id="step-3" class="step hidden">
        <div class="mb-3">
          <h3 class="text-lg font-bold">Order Details</h3>
          <div class="card mt-2 p-3">
            <div class="flex items-center gap-3">
              <div style="width:54px;height:54px;border-radius:8px;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-weight:700;">IMG</div>
              <div>
                <div class="font-semibold">Slides</div>
                <div class="small text-gray-500">Size: 9UK, Black</div>
              </div>
              <div class="ml-auto font-semibold text-red-600">Rs. 999.00</div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <h3 class="text-lg font-bold">Delivery</h3>
          <div class="card mt-2 p-3">
            <div class="small text-gray-600">Name</div>
            <div class="font-medium" id="review-name">—</div>
            <div class="small text-gray-600 mt-2">Mobile</div>
            <div class="font-medium" id="review-mobile">—</div>
            <div class="small text-gray-600 mt-2">Address</div>
            <div class="font-medium" id="review-address">—</div>
            <div class="small text-gray-600 mt-2">Co-ords & DIGIPIN</div>
            <div class="font-medium" id="review-coords-digipin">—</div>
          </div>
        </div>

        <div class="mb-3">
          <h3 class="text-lg font-bold mb-2">Payment Options</h3>
          <div id="payments">
            <label class="payment-option">
              <div>
                <div class="font-semibold">Debit on Delivery</div>
                <div class="small">One-time UPI mandate; amount debited after delivery</div>
              </div>
              <div>Rs. 899</div>
              <input name="payment" type="radio" value="dod" class="ml-3" />
            </label>

            <label class="payment-option">
              <div>
                <div class="font-semibold">UPI</div>
              </div>
              <div>Rs. 999</div>
              <input name="payment" type="radio" value="upi" />
            </label>

            <label class="payment-option">
              <div>
                <div class="font-semibold">Cards</div>
              </div>
              <div>Rs. 999</div>
              <input name="payment" type="radio" value="card" />
            </label>

            <label class="payment-option">
              <div>
                <div class="font-semibold">Cash on Delivery (COD)</div>
                <div class="small">+ Rs.199 surcharge</div>
              </div>
              <div class="text-red-600">Rs. 1198</div>
              <input name="payment" type="radio" value="cod" />
            </label>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="back-to-2" class="btn muted w-1/2">Back</button>
          <button id="pay-now" class="btn primary w-1/2">Pay Now</button>
        </div>
      </div>

      <div id="success" class="hidden text-center">
        <div style="padding:26px;">
          <div style="width:78px;height:78px;border-radius:999px;background:#eaf9ee;margin:12px auto;display:flex;align-items:center;justify-content:center;font-size:28px;color:#2a7f35;">✓</div>
          <h2 class="font-bold text-xl">Order Confirmed</h2>
          <p class="mt-2 text-sm text-gray-600">Your order has been placed successfully. Delivery partner will contact you.</p>
          <div class="mt-6">
            <button id="start-over" class="btn primary">Place New Order</button>
          </div>
        </div>
      </div>

    </div> <!-- content -->
  </div> <!-- frame -->

  <!-- Google Maps JS will be loaded dynamically below.
       Replace YOUR_GOOGLE_MAPS_API_KEY with an actual key that has Maps, Places, Geocoding enabled.
  -->
  <script>
    // --- Utilities / state ---
    let map, marker, geocoder, autocomplete;
    const state = {
      lat: null, lon: null, address: '', digipin: '', door:'', name:'', mobile:''
    };

    // DIGIPIN encoding - adapted/fixed version of your provided function.
    function Get_DIGIPIN(lat, lon) {
      // L grid
      const L = [
        ['F', 'C', '9', '8'],
        ['J', '3', '2', '7'],
        ['K', '4', '5', '6'],
        ['L', 'M', 'P', 'T']
      ];

      let vDIGIPIN = '';
      let row = 0, column = 0;

      // Bounding Box Extent (as in your original)
      let MinLat = 2.5, MaxLat = 38.50, MinLon = 63.50, MaxLon = 99.50;
      let LatDivBy = 4, LonDivBy = 4;

      if (lat < MinLat || lat > MaxLat || lon < MinLon || lon > MaxLon) {
        // fallback: return a simplified code derived from lat/lon if out of range
        const fixedLat = Math.abs(lat).toString().replace('.', '').slice(0,5);
        const fixedLon = Math.abs(lon).toString().replace('.', '').slice(0,5);
        return `${fixedLat}-${fixedLon}`;
      }

      for (let Lvl = 1; Lvl <= 10; Lvl++) {
        const LatDivDeg = (MaxLat - MinLat) / LatDivBy;
        const LonDivDeg = (MaxLon - MinLon) / LonDivBy;

        // find row
        let NextLvlMaxLat = MaxLat;
        let NextLvlMinLat = MaxLat - LatDivDeg;
        row = 0;
        for (let x = 0; x < LatDivBy; x++) {
          if (lat >= NextLvlMinLat && lat < NextLvlMaxLat) {
            row = x;
            break;
          } else {
            NextLvlMaxLat = NextLvlMinLat;
            NextLvlMinLat = NextLvlMaxLat - LatDivDeg;
          }
        }

        // find column
        let NextLvlMinLon = MinLon;
        let NextLvlMaxLon = MinLon + LonDivDeg;
        column = 0;
        for (let x = 0; x < LonDivBy; x++) {
          if (lon >= NextLvlMinLon && lon < NextLvlMaxLon) {
            column = x;
            break;
          } else if ((NextLvlMinLon + LonDivDeg) < MaxLon) {
            NextLvlMinLon = NextLvlMaxLon;
            NextLvlMaxLon = NextLvlMinLon + LonDivDeg;
          } else {
            column = x;
          }
        }

        vDIGIPIN += L[row][column];

        if (Lvl === 3 || Lvl === 6) vDIGIPIN += "-";

        // narrow bounding box for next level
        MinLat = NextLvlMinLat;
        MaxLat = NextLvlMaxLat;
        MinLon = NextLvlMinLon;
        MaxLon = NextLvlMaxLon;
      }
      return vDIGIPIN;
    }

    // Helper to update UI values
    function updateUI() {
      document.getElementById('digipin').innerText = state.digipin || '—';
      document.getElementById('coords').innerText = (state.lat && state.lon) ? `${state.lat.toFixed(7)}, ${state.lon.toFixed(7)}` : '—';
      document.getElementById('coords-pill').innerText = (state.lat && state.lon) ? `${state.lat.toFixed(7)}, ${state.lon.toFixed(7)}` : '—';
      document.getElementById('address-text').innerText = state.address || 'Address not available';
    }

    // Reverse geocode by lat/lng
    function reverseGeocode(lat, lon) {
      if (!geocoder) return;
      const latlng = { lat: parseFloat(lat), lng: parseFloat(lon) };
      geocoder.geocode({ location: latlng }, function(results, status) {
        if (status === 'OK' && results[0]) {
          state.address = results[0].formatted_address;
          state.digipin = Get_DIGIPIN(lat, lon);
          updateUI();
        } else {
          state.address = `Lat ${lat.toFixed(6)}, Lon ${lon.toFixed(6)}`;
          state.digipin = Get_DIGIPIN(lat, lon);
          updateUI();
          console.warn('Geocoder failed: ', status);
        }
      });
    }

    // Initialize map and autocomplete
    function initMap() {
      const defaultCenter = { lat: 17.50383899, lng: 78.40651236 }; // Hyderabad-ish default
      map = new google.maps.Map(document.getElementById('map'), {
        center: defaultCenter,
        zoom: 15,
        disableDefaultUI: true,
        gestureHandling: 'greedy'
      });

      geocoder = new google.maps.Geocoder();

      marker = new google.maps.Marker({
        position: defaultCenter,
        map,
        draggable: true,
        title: 'Drop pin where delivery should happen'
      });

      map.addListener('click', (e) => {
        placeMarker(e.latLng);
      });

      marker.addListener('dragend', function(e) {
        const lat = e.latLng.lat();
        const lng = e.latLng.lng();
        state.lat = lat; state.lon = lng;
        reverseGeocode(lat, lng);
      });

      // Autocomplete (Places)
      const input = document.getElementById('pac-input');
      autocomplete = new google.maps.places.Autocomplete(input, { fields: ["geometry","formatted_address","name"] });
      autocomplete.bindTo('bounds', map);

      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          alert("No details available for the selected place.");
          return;
        }
        const loc = place.geometry.location;
        map.panTo(loc);
        map.setZoom(17);
        placeMarker(loc);
      });

      // initial reverse geocode for default center
      state.lat = defaultCenter.lat; state.lon = defaultCenter.lng;
      reverseGeocode(defaultCenter.lat, defaultCenter.lng);
    }

    function placeMarker(latLng) {
      marker.setPosition(latLng);
      map.panTo(latLng);
      const lat = latLng.lat ? latLng.lat() : latLng.lat;
      const lon = latLng.lng ? latLng.lng() : latLng.lng;
      state.lat = lat;
      state.lon = lon;
      reverseGeocode(lat, lon);
    }

    // use current location
    document.getElementById('use-location').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocation not supported by this browser.');
        return;
      }
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        map.panTo({ lat, lng: lon });
        map.setZoom(17);
        placeMarker({ lat: () => lat, lng: () => lon });
      }, (err) => {
        alert('Could not get your location: ' + err.message);
      }, { enableHighAccuracy:true, timeout:7000 });
    });

    // Navigation between steps
    function showStep(n) {
      document.querySelectorAll('.step').forEach(el => el.classList.add('hidden'));
      document.getElementById('success').classList.add('hidden');
      if (n === 1) document.getElementById('step-1').classList.remove('hidden');
      if (n === 2) document.getElementById('step-2').classList.remove('hidden');
      if (n === 3) document.getElementById('step-3').classList.remove('hidden');
      if (n === 'success') document.getElementById('success').classList.remove('hidden');
    }

    // Button events
    document.getElementById('to-step-2').addEventListener('click', () => {
      if (!state.lat || !state.lon) {
        alert('Please select a location on the map first.');
        return;
      }
      // populate door and name with defaults if present
      document.getElementById('door').value = state.door || '';
      document.getElementById('name').value = state.name || '';
      document.getElementById('mobile').value = state.mobile || '';
      showStep(2);
      updateUI();
    });

    document.getElementById('back-to-1').addEventListener('click', () => showStep(1));

    document.getElementById('to-step-3').addEventListener('click', () => {
      const name = document.getElementById('name').value.trim();
      const mobile = document.getElementById('mobile').value.trim();
      const door = document.getElementById('door').value.trim();

      // mobile validation: 10 digits required
      const mvalid = /^\d{10}$/.test(mobile);
      if (!mvalid) {
        document.getElementById('mobile-error').classList.remove('hidden');
        return;
      } else {
        document.getElementById('mobile-error').classList.add('hidden');
      }

      state.name = name;
      state.mobile = mobile;
      state.door = door;

      // fill review
      const fullAddress = buildFullAddress();
      document.getElementById('review-name').innerText = state.name || '-';
      document.getElementById('review-mobile').innerText = state.mobile || '-';
      document.getElementById('review-address').innerText = fullAddress;
      document.getElementById('review-coords-digipin').innerText = `${state.lat.toFixed(7)}, ${state.lon.toFixed(7)} — ${state.digipin}`;

      showStep(3);
    });

    document.getElementById('back-to-2').addEventListener('click', () => showStep(2));

    document.getElementById('pay-now').addEventListener('click', () => {
      // very light simulation of payment & confirmation
      const chosen = document.querySelector('input[name="payment"]:checked');
      if (!chosen) {
        alert('Please choose a payment option.');
        return;
      }
      // In real app send payload to server: state + chosen.value
      // Show success
      showStep('success');
    });

    document.getElementById('start-over').addEventListener('click', () => {
      // reset everything
      state.lat = null; state.lon = null; state.address=''; state.digipin='';
      state.door=''; state.name=''; state.mobile='';
      document.getElementById('pac-input').value = '';
      updateUI();
      showStep(1);
      // attempt to pan back to default
      if (map) map.setCenter({ lat:17.50383899, lng:78.40651236 });
    });

    function buildFullAddress() {
      let parts = [];
      if (state.name) parts.push(state.name + ',');
      if (state.mobile) parts.push(state.mobile + ',');
      if (state.door) parts.push(state.door + ',');
      if (state.address) parts.push(state.address);
      return parts.join(' ').replace(/\s+,/g, ',');
    }

    // Load Google Maps script dynamically and init
    function loadGoogleMaps() {
      const script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=&libraries=places&callback=initMap';
      script.defer = true;
      script.async = true;
      window.initMap = initMap;
      document.head.appendChild(script);
    }

    // Init UI values and load maps
    updateUI();
    loadGoogleMaps();

  </script>
</body>
</html>
